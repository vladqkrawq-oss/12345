from telebot import types
import config
import sqlite3
import requests
import json
import time
from datetime import datetime

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
invoices = {}

# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° CRYPTOBOT ==========

def get_crypto_invoice(amount_rub):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –≤ Cryptobot"""
    if not config.CRYPTOPAY_API_TOKEN:
        return None, None
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è RUB –≤ USDT (–ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å)
    usdt_rate = get_usdt_rate()
    amount_usdt = round(amount_rub / usdt_rate, 2)
    
    url = "https://pay.crypt.bot/api/createInvoice"
    headers = {
        "Crypto-Pay-API-Token": config.CRYPTOPAY_API_TOKEN,
        "Content-Type": "application/json"
    }
    
    # –°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    payload = f"user_{int(time.time())}"
    
    data = {
        "asset": "USDT",
        "amount": str(amount_usdt),
        "description": f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ {amount_rub} RUB",
        "payload": payload,
        "paid_btn_name": "viewItem",
        "paid_btn_url": "https://t.me/YourBotUsername",  # –ó–∞–º–µ–Ω–∏ –Ω–∞ username —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞
        "allow_comments": False,
        "allow_anonymous": False,
        "expires_in": 300  # 5 –º–∏–Ω—É—Ç
    }
    
    try:
        response = requests.post(url, headers=headers, json=data, timeout=10)
        if response.status_code == 200:
            result = response.json()
            if result.get('ok'):
                invoice = result['result']
                return invoice['pay_url'], invoice['invoice_id'], payload, amount_usdt
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞ Cryptobot: {e}")
    
    return None, None, None, None

def check_crypto_payment(invoice_id):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –≤ Cryptobot"""
    if not config.CRYPTOPAY_API_TOKEN:
        return None
    
    url = "https://pay.crypt.bot/api/getInvoices"
    headers = {
        "Crypto-Pay-API-Token": config.CRYPTOPAY_API_TOKEN,
        "Content-Type": "application/json"
    }
    
    params = {
        "invoice_ids": str(invoice_id)
    }
    
    try:
        response = requests.get(url, headers=headers, params=params, timeout=10)
        if response.status_code == 200:
            result = response.json()
            if result.get('ok') and result.get('result', {}).get('items'):
                for invoice in result['result']['items']:
                    if str(invoice['invoice_id']) == str(invoice_id):
                        return invoice['status']
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞: {e}")
    
    return None

def get_usdt_rate():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ USDT –∫ RUB"""
    try:
        response = requests.get("https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=rub", timeout=10)
        if response.status_code == 200:
            return response.json()['tether']['rub']
    except:
        pass
    # –ö—É—Ä—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    return 90.0

# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ÆMONEY ==========

def check_yoomoney_payment(label):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –ÆMoney"""
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ÆMoney
    # –¢–∞–∫ –∫–∞–∫ —É —Ç–µ–±—è –Ω–µ—Ç YOOMONEY_API_TOKEN –≤ config.py, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞
    return None

# ========== –û–°–ù–û–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========

def setup_payment_handlers(bot):
    
    @bot.callback_query_handler(func=lambda call: call.data == 'top_up')
    def top_up_balance(call):
        bot.answer_callback_query(call.id)
    
    @bot.callback_query_handler(func=lambda call: call.data == 'top_up_cryptobot')
    def top_up_cryptobot(call):
        msg = bot.send_message(
            call.message.chat.id,
            "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö (–æ—Ç 50 –¥–æ 15000 —Ä—É–±):\n"
            "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 50 RUB\n"
            "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 15000 RUB",
            reply_markup=types.ReplyKeyboardRemove()
        )
        bot.register_next_step_handler(msg, process_crypto_payment)
    
    def process_crypto_payment(message):
        try:
            amount_rub = float(message.text.strip())
            chat_id = message.chat.id
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã
            if amount_rub < 50 or amount_rub > 15000:
                bot.send_message(
                    chat_id, 
                    "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 50 –¥–æ 15000 —Ä—É–±.\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:",
                    reply_markup=types.ReplyKeyboardRemove()
                )
                bot.register_next_step_handler(message, process_crypto_payment)
                return
            
            # –°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç –≤ Cryptobot
            pay_url, invoice_id, payload, amount_usdt = get_crypto_invoice(amount_rub)
            
            if pay_url and invoice_id:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
                invoices[invoice_id] = {
                    'chat_id': chat_id,
                    'amount_rub': amount_rub,
                    'amount_usdt': amount_usdt,
                    'status': 'pending',
                    'created_at': time.time()
                }
                
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–ø–ª–∞—Ç—É
                markup = types.InlineKeyboardMarkup(row_width=1)
                pay_button = types.InlineKeyboardButton(
                    text=f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {amount_usdt} USDT (~{amount_rub} RUB)", 
                    url=pay_url
                )
                check_button = types.InlineKeyboardButton(
                    text="üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É", 
                    callback_data=f'check_crypto_{invoice_id}'
                )
                cancel_button = types.InlineKeyboardButton(
                    text="‚ùå –û—Ç–º–µ–Ω–∞", 
                    callback_data=f'cancel_crypto_{invoice_id}'
                )
                markup.add(pay_button, check_button, cancel_button)
                
                bot.send_message(
                    chat_id,
                    f"üßæ –°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É —Å–æ–∑–¥–∞–Ω!\n\n"
                    f"üí∞ –°—É–º–º–∞: {amount_rub} RUB\n"
                    f"üíµ –í USDT: ~{amount_usdt} USDT\n\n"
                    f"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª\n"
                    f"2. –û–ø–ª–∞—Ç–∏—Ç–µ —Å—á–µ—Ç –≤ @CryptoBot\n"
                    f"3. –ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª\n\n"
                    f"‚è≥ –°—á–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç",
                    reply_markup=markup
                )
            else:
                bot.send_message(
                    chat_id,
                    "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                    reply_markup=types.ReplyKeyboardRemove()
                )
                
        except ValueError:
            bot.send_message(
                message.chat.id,
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (—Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö):",
                reply_markup=types.ReplyKeyboardRemove()
            )
            bot.register_next_step_handler(message, process_crypto_payment)
    
    @bot.callback_query_handler(func=lambda call: call.data.startswith('check_crypto_'))
    def check_crypto_payment_handler(call):
        invoice_id = call.data.split('_')[2]
        
        if invoice_id in invoices:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
            status = check_crypto_payment(invoice_id)
            
            if status == 'paid':
        markup = types.InlineKeyboardMarkup(row_width=2)
        cryptobot_button = types.InlineKeyboardButton(text="ü§ñ CryptoBot", callback_data='top_up_cryptobot')
        markup.add(cryptobot_button)
        bot.send_message(
            call.message.chat.id, 
            "üí≥ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:\n\n"
            "ü§ñ CryptoBot - –æ–ø–ª–∞—Ç–∞ –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–µ (USDT)",
            reply_markup=markup
                )
        # –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
                payment_info = invoices[invoice_id]
                chat_id = payment_info['chat_id']
                amount_rub = payment_info['amount_rub']
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                conn = sqlite3.connect(config.DATABASE_NAME)
                cursor = conn.cursor()
                
                # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É users –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                cursor.execute('''CREATE TABLE IF NOT EXISTS users
                                  (id INTEGER PRIMARY KEY,
                                   balance REAL DEFAULT 0,
                                   first_name TEXT,
                                   username TEXT)''')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                cursor.execute('SELECT id FROM users WHERE id = ?', (chat_id,))
                if cursor.fetchone():
                    cursor.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (amount_rub, chat_id))
                else:
                    cursor.execute('INSERT INTO users (id, balance, first_name) VALUES (?, ?, ?)',
                                 (chat_id, amount_rub, call.from_user.first_name))
                
                conn.commit()
                conn.close()
                
                # –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
                del invoices[invoice_id]
                
                # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
                bot.delete_message(chat_id, call.message.message_id)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                bot.send_message(
                    chat_id,
                    f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n"
                    f"üí∞ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount_rub} RUB",
                    reply_markup=get_main_keyboard(chat_id)
                )
                
                bot.answer_callback_query(call.id, "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!")
                
            elif status == 'active':
                bot.answer_callback_query(call.id, "‚è≥ –°—á–µ—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –µ—â—ë –Ω–µ –æ–ø–ª–∞—á–µ–Ω", show_alert=False)
            else:
                bot.answer_callback_query(call.id, "‚ùå –°—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫", show_alert=True)
        else:
            bot.answer_callback_query(call.id, "‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
    
    @bot.callback_query_handler(func=lambda call: call.data.startswith('cancel_crypto_'))
    def cancel_crypto_payment(call):
        invoice_id = call.data.split('_')[2]
        
        if invoice_id in invoices:
            del invoices[invoice_id]
            bot.delete_message(call.message.chat.id, call.message.message_id)
            bot.send_message(
                call.message.chat.id,
                "‚ùå –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω—ë–Ω",
                reply_markup=get_main_keyboard(call.message.chat.id)
            )
        
        bot.answer_callback_query(call.id)

def get_main_keyboard(chat_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    
    if chat_id == config.ADMIN_ID:
        markup.add(
            types.KeyboardButton("üõç –ö–∞—Ç–∞–ª–æ–≥"),
            types.KeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å"),
            types.KeyboardButton("üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
        )
        markup.add(types.KeyboardButton("üìä –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"))
    else:
        markup.add(
            types.KeyboardButton("üõç –ö–∞—Ç–∞–ª–æ–≥"),
            types.KeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å"),
            types.KeyboardButton("üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
        )
    
    return markup

